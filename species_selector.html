<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Species selector</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <style id="zoo_species_selected"></style>
</head>
<body>
<div style="width: 50%; height: 100%; float: left; position: fixed;">
    <div id="map"></div>
</div>
<div id="selector" style="margin-left: 50%;">
    <a href="index.html">Back to user index</a><br />
    <h1>Just a test species selector</h1>
    Animal list:<ul id='animals' class='odd'></ul>
    <ul id="selected-animals"></ul>
    <ul id="selected-zoos"></ul>
</div>
</body>

<script>
    let map = null;
    let categoryLevelCache = [];
    let speciesPromiseCache = [];
    let selectedSpecies = [];
    let zooMarkers = {};
    let zooInfoWindows = {};
    function getCategoryLevel(id) {
        let result = null;
        $.each(categoryLevelCache, function(idx, val) {
            if(val.category_level_id === id) {
                result = val;
            }
        });
        return result;
    }

    /**
     * I pulled this method from somewhere else, tbh
     * @param url
     * @returns {Promise}
     */
    function promiseGet(url) {
        // Return a new promise.
        return new Promise(function (resolve, reject) {
            // Do the usual XHR stuff
            let req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function () {
                // This is called even on 404 etc
                // so check the status
                if (req.status === 200) {
                    // Resolve the promise with the response text
                    resolve(JSON.parse(req.responseText));
                } else {
                    // Otherwise reject with the status text
                    // which will hopefully be a meaningful error
                    reject(Error(req.statusText));
                }
            };

            // Handle network errors
            req.onerror = function () {
                reject(Error("Network Error"));
            };

            // Make the request
            req.send();
        });
    }

    /**
     * Retrieves species data from the cache
     * @param id species id to retrieve
     */
    function getSpeciesFromCache(id) {
        if(speciesPromiseCache[id]) {
            return speciesPromiseCache[id];
        } else {
            const promise = promiseGet("http://localhost:3000/species/"+id).then(function(data) {
                return data[0];
            });
            speciesPromiseCache[id] = promise;
            return promise;
        }
    }

    /**
     * Creates a new google maps marker for a given zoo and saves to cache
     * @param zooData data object of the zoo
     */
    function getZooMarker(zooData) {
        const zooId = zooData.zoo_id;
        if (!zooMarkers[zooId]) {
            zooMarkers[zooId] = new google.maps.Marker({
                position: {lat: zooData.latitude, lng: zooData.longitude},
                map: map,
                title: zooData.name
            });
            getZooInfoWindow(zooId).then(function(infoWindow) {
                zooMarkers[zooId].addListener("click", function () {
                    infoWindow.open(map, zooMarkers[zooId]);
                });
            });
        }
        return zooMarkers[zooId];
    }

    function getZooInfoWindow(zooId) {
        return promiseGet("http://localhost:3000/zoos/"+zooId).then(function(zoosData) {
            const zooData = zoosData[0];
            let infoContent = "<h1>"+zooData.name+"</h1>" +
                    "<a href='"+zooData.link+"'>"+zooData.link+"</a><br />" +
                    "<span style='font-weight: bold'>Postcode:</span> " + zooData.postcode + "<br />" +
                    "<h2>Species:</h2>" +
                    "<ul class='zoo_species'>";
            $.each(zooData.species, function(idx, zooSpecies) {
                infoContent += "<li class='zoo_species zoo_species_"+zooSpecies.species_id+"'>"+zooSpecies.common_name+" <span class='latin_name'>"+zooSpecies.latin_name+"</span>";
            });
            infoContent += "</ul>";
            return new google.maps.InfoWindow({
                content: infoContent
            });
        });
    }

    /**
     * Adds a new category to the dom
     * @param parentUlElement ul element of the parent category for the category
     * @param categoryData data object for the new category
     */
    function addCategory(parentUlElement, categoryData) {
        const categoryId = categoryData.category_id;
        const name = categoryData.name;
        const categoryLevelId = categoryData.category_level_id;
        const categoryLiId = "category-"+categoryId;
        const categoryLevelName = getCategoryLevel(categoryLevelId).name;
        parentUlElement.append(
            "<li class='category closed' id='"+categoryLiId+"'>" +
                "<span onclick='loadCategory("+categoryId+", true, false)'>" +
                    "<span class='category_name'>" + name + "</span> " +
                    "<span class='category_level'>"+categoryLevelName+"</span>" +
                "</span> " +
                "<span class='selector' onclick='selectCategory("+categoryId+")'></span>" +
            "</li>");
        if(parentUlElement.parent().hasClass("selected")) {
            $("#"+categoryLiId).addClass("selected");
            updateSelected();
        }
    }

    /**
     * Adds a new species to the dom
     * @param parentUlElement ul element of the parent category for the species
     * @param speciesData data object for the new species
     */
    function addSpecies(parentUlElement, speciesData) {
        const speciesId = speciesData.species_id;
        const speciesLiId = "species-"+speciesId;
        const name = speciesData.common_name;
        const latinName = speciesData.latin_name;
        //speciesCache[speciesId] = speciesData;
        parentUlElement.append(
            "<li class='species' id='"+speciesLiId+"'>" +
                "<span class='species_name'>"+name+" </span>" +
                "<span class='latin_name'>"+latinName+"</span>" +
                "<span class='selector' onclick='selectSpecies("+speciesId+")'></span>" +
            "</li>");
        if(parentUlElement.parent().hasClass("selected")) {
            $("#"+speciesLiId).addClass("selected");
            updateSelected();
        }
    }

    function loadCategory(id, expand, recursive) {
        const categoryLiId = "category-"+id;
        let categoryElem = $("#"+categoryLiId);
        const isOdd = categoryElem.parent("ul").hasClass("odd");
        let populatedCategoriesPromise = Promise.resolve([]);
        if(categoryNotPopulated(categoryElem)) {
            populatedCategoriesPromise = promiseGet("http://localhost:3000/categories/"+id).then(function(/*[CategoryObj]*/categoryObjs) {
                const categoryObj = categoryObjs[0];
                // Add base list element
                categoryElem.append("<ul class='" + (isOdd ? "even" : "odd") + "' style='display: none;'></ul>");
                // Add subcategories
                $.each(categoryObj.sub_categories, function (index, itemData) {
                    addCategory(categoryElem.find("ul"), itemData);
                });
                // Add species in category
                $.each(categoryObj.species, function (index, itemData) {
                    addSpecies(categoryElem.find("ul"), itemData);
                });
                // If category contains only 1 subcategory, open the subcategory. (or if recursive is specified)
                let loadCategoryPromises = [];
                if (categoryElem.children("ul").children("li.category").length === 1 || recursive) {
                    $.each(categoryObj.sub_categories, function (idx, subCategory) {
                        loadCategoryPromises.push(loadCategory(subCategory.category_id, expand, recursive));
                    })
                }
                return Promise.all(loadCategoryPromises);
            });
        } else if (recursive) {
            const subCategoryElems = categoryElem.children("ul").children("li.category");
            let loadCategoryPromises = [];
            subCategoryElems.each(function(idx, elem) {
                loadCategoryPromises.push(loadCategory(elem.id.split("-")[1], expand, recursive));
            });
            populatedCategoriesPromise = Promise.all(loadCategoryPromises);
        }
        return populatedCategoriesPromise.then(function(loadedCategories) {
            if (expand) {
                expandCategory(categoryElem);
            }
        });
    }

    function expandCategory(categoryElem) {
        if(categoryElem.children("ul").is(":visible")) {
            categoryElem.find("ul").first().hide();
            categoryElem.addClass("closed");
            categoryElem.removeClass("open");
        } else {
            categoryElem.find("ul").first().show();
            categoryElem.addClass("open");
            categoryElem.removeClass("closed");
            const childCategoryElems = categoryElem.children("ul").children("li.category");
            if(childCategoryElems.length === 1 && !childCategoryElems.children("ul").is(":visible")) {
                expandCategory(categoryElem.children("ul").children("li.category"));
            }
        }
    }

    /**
     * Checks if a category has been populated with subcategory and species data
     * @param categoryElem category element
     * @returns {boolean}
     */
    function categoryNotPopulated(categoryElem) {
        return !categoryElem.has("ul").length;
    }

    function selectCategory(categoryId) {
        let categoryElem = $("li#category-"+categoryId);
        categoryElem.toggleClass("selected");
        categoryElem.find("li").toggleClass("selected");
        loadCategory(categoryId, false, true).then(function(data) {
            updateSelected();
        });
    }

    function selectSpecies(speciesId) {
        $("li#species-"+speciesId).toggleClass("selected");
        updateSelected();
    }

    function hideAllMarkers() {
        $.each(zooInfoWindows, function(zooId, infoWindow) {
            infoWindow.close();
        });
        $.each(zooMarkers, function(zooId, marker) {
            marker.setVisible(false);
        });
        $("li.zoo_species").removeClass("selected_species");
    }

    function updateSelected() {
        let selected = $("#selected-animals");
        selected.empty();
        selectedSpecies = [];
        let zooSpeciesSelected = $("#zoo_species_selected");
        zooSpeciesSelected.empty();
        let speciesDataPromises = [];
        $("li.species.selected").each(function(idx, elem) {
            const speciesId = elem.id.split("-")[1];
            zooSpeciesSelected.append("li.zoo_species_"+speciesId+" { font-weight:bold; }");
            selectedSpecies.push(speciesId);
            const speciesName = $(this).children(".species_name").text();
            selected.append("<li>"+speciesName+" ("+speciesId+")</li>");

            speciesDataPromises.push(getSpeciesFromCache(speciesId).then(function(/*SpeciesObj*/speciesData) {
                let selectedZoos = {};
                $.each(speciesData.zoos, function (zooIdx, zooData) {
                    selectedZoos[zooData.zoo_id] = zooData;
                });
                return selectedZoos;
            }));
        });
        Promise.all(speciesDataPromises).then(function(selectedZooList) {
            const selectedZoos = Object.assign({}, ...selectedZooList);
            // Update zoos selected
            let selectedZoosElem = $("#selected-zoos");
            selectedZoosElem.empty();
            hideAllMarkers();
            $.each(selectedZoos, function(zooKey, zooData) {
                selectedZoosElem.append("<li>"+zooData.name+"</li>");
                const marker = getZooMarker(zooData);
                marker.setVisible(true);
            });
        });
    }

    $(document).ready(function() {
        promiseGet("http://localhost:3000/category_levels/").then(function(data) {
            categoryLevelCache = data;
            return promiseGet("http://localhost:3000/categories/");
        }).then(function(data) {
            $.each(data, function(index, itemData) {
                addCategory($("#animals"), itemData);
            });
        });
    });

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: {lat: 55, lng: -3}
        });
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap"> //TODO add key
</script>
</html>