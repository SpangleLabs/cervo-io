<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Species selector</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div style="width: 600px; height: 100%; float: left; position: fixed;">
    <div id="map"></div>
</div>
<div id="selector" style="margin-left: 600px;">
    <h1>Just a test species selector</h1>
    <a href="index.html">Back to user index</a><br />
    Animal list:<ul id='animals' class='odd'></ul>
    <ul id="selected-animals"></ul>
    <ul id="selected-zoos"></ul>
</div>
</body>

<script>
    var map = null;
    var categoryLevelCache = [];
    var speciesCache = {};
    var zoosCache = {};
    var selectedSpecies = [];
    var selectedZoos = [];
    var markers = [];
    $.get("http://localhost:3000/category_levels/", function(data) {
        categoryLevelCache = data;
    });
    function getCategoryLevel(id) {
        for ( var a = 0; a < categoryLevelCache.length; a++ ) {
            if(categoryLevelCache[a].category_level_id === id) {
                return categoryLevelCache[a];
            }
        }
    }

    function getSpeciesFromCache(id, func) {
        //TODO: promisify
        if(speciesCache[id]) {
            func(speciesCache[id]);
        } else {
            $.get("http://localhost:3000/species/"+id, function(speciesObjs) {
                speciesCache[id] = speciesObjs[0];
                func(speciesObjs[0]);
            });
        }
    }

    function addMarkerToZoo(zooData) {
        zooData.marker = new google.maps.Marker({
            position: {lat: zooData.latitude, lng: zooData.longitude},
            map: map,
            title: zooData.name
        });
        markers.push(zooData.marker);
        return zooData;
    }

    function getZooFromCache(id) {
        //TODO: promisify
        if(zoosCache[id]) {
            return zoosCache[id];
        } else {
            $.get("http://localhost:3000/zoos/"+id, function(/*[ZooObj]*/zooObjs) {
                zoosCache[id] = zooObjs[0];
            });
        }
    }

    function addCategory(parentUlElement, categoryData) {
        var categoryId = categoryData.category_id;
        var name = categoryData.name;
        var categoryLevelId = categoryData.category_level_id;
        var categoryLiId = "category-"+categoryId;
        var categoryLevelName = getCategoryLevel(categoryLevelId).name;
        parentUlElement.append(
            "<li class='category closed' id='"+categoryLiId+"'>" +
                "<span onclick='loadCategory("+categoryId+", true, false)'>" +
                    "<span class='category_name'>" + name + "</span> " +
                    "<span class='category_level'>"+categoryLevelName+"</span>" +
                "</span> " +
                "<span class='selector' onclick='selectCategory("+categoryId+")'></span>" +
            "</li>");
        if(parentUlElement.parent().hasClass("selected")) {
            $("#"+categoryLiId).addClass("selected");
            updateSelected();
        }
    }

    function addSpecies(parentUlElement, speciesData) {
        var speciesId = speciesData.species_id;
        var speciesLiId = "species-"+speciesId;
        var name = speciesData.common_name;
        var latinName = speciesData.latin_name;
        //speciesCache[speciesId] = speciesData;
        parentUlElement.append(
            "<li class='species' id='"+speciesLiId+"'>" +
                "<span class='species_name'>"+name+" </span>" +
                "<span class='latin_name'>"+latinName+"</span>" +
                "<span class='selector' onclick='selectSpecies("+speciesId+")'></span>" +
            "</li>");
        if(parentUlElement.parent().hasClass("selected")) {
            $("#"+speciesLiId).addClass("selected");
            updateSelected();
        }
    }

    function loadCategory(id, expand, recursive) {
        var categoryLiId = "category-"+id;
        var categoryElem = $("#"+categoryLiId);
        var isOdd = categoryElem.parent("ul").hasClass("odd");
        if(categoryNotPopulated(categoryElem)) {
            $.get("http://localhost:3000/categories/"+id, function(/*[CategoryObj]*/categoryObjs) {
                // If told to expand category also, do that.
                var categoryObj = categoryObjs[0];
                categoryElem.append("<ul class='"+(isOdd?"even":"odd")+"' style='display: none;'></ul>");
                // Add subcategories
                $.each(categoryObj.sub_categories, function (index, itemData) {
                    addCategory(categoryElem.find("ul"), itemData);
                });
                // Add species in category
                $.each(categoryObj.species, function (index, itemData) {
                    addSpecies(categoryElem.find("ul"), itemData);
                });
                // If category contains only 1 subcategory, open the subcategory. (or if recursive is specified)
                if(categoryElem.children("ul").children("li.category").length === 1 || recursive) {
                    var subCategories = categoryObj.sub_categories;
                    $.each(subCategories, function(idx, subCategory) {
                        loadCategory(subCategory.category_id, expand, recursive);
                    })
                }
                if (expand) {
                    expandCategory(categoryElem);
                }
            });
        } else {
            if (expand) {
                expandCategory(categoryElem);
            }
            if (recursive) {
                var subCategoryElems = categoryElem.children("ul").children("li.category");
                subCategoryElems.each(function(idx, elem) {
                    loadCategory(elem.id.split("-")[1], expand, recursive);
                });
            }
        }
    }

    function expandCategory(categoryElem) {
        if(categoryElem.children("ul").is(":visible")) {
            categoryElem.find("ul").first().hide();
            categoryElem.addClass("closed");
            categoryElem.removeClass("open");
        } else {
            categoryElem.find("ul").first().show();
            categoryElem.addClass("open");
            categoryElem.removeClass("closed");
            var childCategoryElems = categoryElem.children("ul").children("li.category");
            if(childCategoryElems.length === 1 && !childCategoryElems.children("ul").is(":visible")) {
                expandCategory(categoryElem.children("ul").children("li.category"));
            }
        }
    }

    function categoryNotPopulated(categoryElem) {
        return !categoryElem.has("ul").length;
    }

    function selectCategory(categoryId) {
        var categoryElem = $("li#category-"+categoryId);
        categoryElem.toggleClass("selected");
        categoryElem.find("li").toggleClass("selected");
        loadCategory(categoryId, false, true);
        updateSelected();
    }

    function selectSpecies(speciesId) {
        $("li#species-"+speciesId).toggleClass("selected");
        updateSelected();
    }

    function hideAllMarkers() {
        console.log("hiding");
        $.each(markers, function(idx, marker) {
            marker.setVisible(false);
        });
    }

    function updateSelected() {
        var selected = $("#selected-animals");
        selected.empty();
        selectedSpecies = [];
        selectedZoos = {};
        $("li.species.selected").each(function(idx, elem) {
            var speciesId = elem.id.split("-")[1];
            selectedSpecies.push(speciesId);
            var speciesName = $(this).children(".species_name").text();
            selected.append("<li>"+speciesName+" ("+speciesId+")</li>");

            getSpeciesFromCache(speciesId, function(speciesData) {
                $.each(speciesData.zoos, function (zooIdx, zooElem) {
                    addMarkerToZoo(zooElem);
                    selectedZoos[zooElem.zoo_id] = zooElem;
                });
            });
        });
        // Update zoos selected
        var selectedZoosElem = $("#selected-zoos");
        selectedZoosElem.empty();
        hideAllMarkers();
        $.each(selectedZoos, function(zooKey, zooVal) {
            selectedZoosElem.append("<li>"+zooVal.name+"</li>");
            zooVal.marker.setVisible(true);
        });
    }

    function eventSubmitPostcode() {
        $.get("http://localhost:3000/categories/", function(data) {
            $.each(data, function(index, itemData) {
                addCategory($("#animals"), itemData);
            });
        });
    }

    $(document).ready(function() {
        eventSubmitPostcode();
    });

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: {lat: 55, lng: -3}
        });
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap"> //TODO add key
</script>
</html>