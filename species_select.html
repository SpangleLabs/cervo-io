<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select species</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<h1>Select species to get distances</h1>
<a href="index.html">Back to user index</a><br />
<form onsubmit="return eventSubmitPostcode()">
    <label>Postcode:
        <input type="text" name="postcode" id="form-postcode"/>
    </label>
    <input type="submit" id="form-submit"/>
</form><br />
</body>

<script>
    var categoryLevelCache = [];
    $.get("http://localhost:3000/category_levels/", function(data) {
        categoryLevelCache = data;
    });
    function getCategoryLevel(id) {
        for ( var a = 0; a < categoryLevelCache.length; a++ ) {
            if(categoryLevelCache[a].category_level_id === id) {
                return categoryLevelCache[a];
            }
        }
    }

    function addCategory(element, categoryData) {
        var categoryId = categoryData.category_id;
        var name = categoryData.name;
        var categoryLevelId = categoryData.category_level_id;
        var categoryLiId = "category-"+categoryId;
        var categoryLevelName = getCategoryLevel(categoryLevelId).name;
        element.append("<li class='category closed' id='"+categoryLiId+"'>" +
            "<span onclick='loadCategory("+categoryId+")'>"+name+"</span> " +
            "<span class='category_level'>"+categoryLevelName+"</span>" +
            "<a href='locate_zoo.html?type=category&id="+categoryId+"&postcode="+$("input").first().val()+"'>üîç</a>" +
            "</li>");
    }

    function addSpecies(element, speciesData) {
        var speciesId = speciesData.species_id;
        var name = speciesData.common_name;
        var latinName = speciesData.latin_name;
        element.append("<li class='species'>"+name+" <span class='latin_name'>"+latinName+"</span>" +
            "<a href='locate_zoo.html?type=species&id="+speciesId+"&postcode="+$("input").first().val()+"'>üîç</a>" +
            "</li>");
    }

    function loadCategory(id) {
        var categoryLiId = "category-"+id;
        $.get("http://localhost:3000/categories/"+id, function(/*CategoryObj*/data) {
            var listElement = $("#"+categoryLiId);
            var isOdd = listElement.parent("ul").hasClass("odd");
            listElement.addClass("open");
            listElement.removeClass("closed");
            if(!listElement.has("ul").length) {
                listElement.append("<ul class='"+(isOdd?"even":"odd")+"'></ul>");
                // Add subcategories and species
                $.each(data[0].sub_categories, function (index, itemData) {
                    addCategory(listElement.find("ul"), itemData);
                });
                $.each(data[0].species, function (index, itemData) {
                    addSpecies(listElement.find("ul"), itemData);
                });
                // If category contains only 1 subcategory, open the subcategory.
                if(data[0].sub_categories.length === 1 && data[0].species.length === 0) {
                    loadCategory(data[0].sub_categories[0].category_id);
                }
            } else if(!listElement.find("ul").is(":visible")) {
                listElement.find("ul").first().show();
                listElement.addClass("open");
                listElement.removeClass("closed");
            } else {
                listElement.find("ul").first().hide();
                listElement.addClass("closed");
                listElement.removeClass("open");
            }
        })
    }

    function eventSubmitPostcode() {
        $("body").append("Animal list:<ul id='animals' class='odd'></ul>");
        $.get("http://localhost:3000/categories/", function(data) {
            $.each(data, function(index, itemData) {
                addCategory($("#animals"), itemData);
            });
        });
        $("input#form-postcode").prop("disabled",true);
        $("input#form-submit").prop("disabled",true);
        return false;
    }
</script>
</html>