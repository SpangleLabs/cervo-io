<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find zoo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>

Searching for:
<ul id="species_list"></ul>
Zoos:
<ul id="zoo_list"></ul>

<script>
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    var speciesIdList = [];
    var zooIdList = [];

    function load_species_list() {
        var getType = getUrlParameter("type");
        if(getType === "species") {
            var speciesId = getUrlParameter("id");
            add_species_to_list(speciesId);
        } else {
            var categoryId = getUrlParameter("id");
            get_species_from_category(categoryId);
        }
    }

    function get_species_from_category(id) {
        console.log("get species");
        $.get("http://localhost:3000/categories/"+id, function(data) {
            for(var a = 0; a < data.length; a++) {
                var subcats = data[a].sub_categories;
                var species = data[a].species;
                for(var b = 0; b < species.length; b++) {
                    add_species_to_list(species[b].species_id);
                }
                for(var c = 0; c < subcats.length; c++) {
                    get_species_from_category(subcats[c].category_id);
                }
            }
            // All species are added, now add the zoos
            console.log("Species added");
            get_zoo_distances();
        });
    }

    function add_species_to_list(species_id) {
        speciesIdList.push(species_id);
        $.get("http://localhost:3000/species/"+species_id, function(data) {
            $("#species_list").append("<li>"+data[0].common_name+"</li>");
            for(var a = 0; a < data[0].zoos.length; a++ ) {
                var zooData = data[0].zoos[a];
                if(zooIdList.indexOf(zooData.zoo_id) === -1) {
                    $("#zoo_list").append("<li id='zoo-"+zooData.zoo_id+"'>" + zooData.name + "</li>");
                    zooIdList.push(zooData.zoo_id);
                }
            }
        });
    }

    function get_zoo_distances() {
        var userPostcode = getUrlParameter("postcode");
        $.get("http://localhost:3000/zoo_distances/"+userPostcode+"/"+zooIdList.join(","), function(data) {
            for(var a = 0; a < zooIdList.length; a++) {
                $("li#zoo-"+zooIdList[a]).append(" Distance: "+data[a].metres);
            }
        });
    }

    $(document).ready(function() {
        load_species_list();
        //get_zoo_distances();
    });
</script>
</body>
</html>