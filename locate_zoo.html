<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find zoo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<a href="index.html">Back to user index</a><br />

Searching for:
<ul id="species_list"></ul>
Zoos:
<ul id="zoo_list"></ul>

<script>
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    function get(url) {
        // Return a new promise.
        return new Promise(function (resolve, reject) {
            // Do the usual XHR stuff
            var req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function () {
                // This is called even on 404 etc
                // so check the status
                if (req.status === 200) {
                    // Resolve the promise with the response text
                    resolve(JSON.parse(req.response));
                } else {
                    // Otherwise reject with the status text
                    // which will hopefully be a meaningful error
                    reject(Error(req.statusText));
                }
            };

            // Handle network errors
            req.onerror = function () {
                reject(Error("Network Error"));
            };

            // Make the request
            req.send();
        });
    }

    function domAddSpecies(speciesData) {
        $("#species_list").append("<li>"+speciesData.common_name+"</li>");
    }

    function domAddZoo(zooData) {
        var zooId = zooData.zoo_id;
        var zooName = zooData.name;
        $("#zoo_list").append("<li id='zoo-"+zooId+"'>"+zooName+"</li>");
    }

    function domAddZooDistance(zooDistanceData) {
        var zooId = zooDistanceData.zoo_id;
        var distance = zooDistanceData.metres/1000;
        $("li#zoo-"+zooId).append(" - "+distance+"km");
    }

    function domReorderZoos(distanceMap) {
        var distanceSort = Object.keys(distanceMap).sort(function(a, b){return b-a});
        for(var a = 0; a < distanceSort.length; a++) {
            var zooLi = $("li#zoo-"+distanceMap[distanceSort[a]]);
            zooLi.parent().prepend(zooLi);
        }
    }

    function promiseGetSpecies(speciesId) {
        //return a species promise which returns species data
        return get("http://localhost:3000/species/"+speciesId);
    }

    function promiseRawGetCategory(categoryId) {
        return get("http://localhost:3000/categories/"+categoryId);
    }

    function promiseGetCategory(categoryId) {
        //return a category promise which returns species promises
        var categoryPromises = [];
        var speciesPromises = [];
        var result = promiseRawGetCategory(categoryId).then(function(data) {
            for (var a = 0; a < data.length; a++) {
                var subcats = data[a].sub_categories;
                var species = data[a].species;
                for (var b = 0; b < species.length; b++) {
                    speciesPromises.push(promiseGetSpecies(species[b].species_id));
                }
                for (var c = 0; c < subcats.length; c++) {
                    categoryPromises.push(promiseGetCategory(subcats[c].category_id));
                }
            }
            return Promise.all(categoryPromises);
        }).then(function(specPromises) {
            var specPromisesConcat = Array.prototype.concat.apply([],specPromises);
            return speciesPromises.concat(specPromisesConcat);
        });
        return result;
    }

    $(document).ready(function() {
        var postcode = getUrlParameter("postcode");
        promiseGetCategory(getUrlParameter("id")).then(function(data) {
            return Promise.all(data);
        }).then(function(speciesData) {
            // Add species to the list
            var speciesIdList = [];
            var zoosData = {};
            for(var a = 0; a < speciesData.length; a++) {
                domAddSpecies(speciesData[a][0]);
                speciesIdList.push(speciesData[a][0].species_id);
                for(var b = 0; b < speciesData[a][0].zoos.length; b++) {
                    var zooData = speciesData[a][0].zoos[b];
                    var zooId = zooData.zoo_id;
                    if(!(zooId in zoosData)) {
                        zoosData[zooId] = zooData;
                        domAddZoo(zooData);
                    }
                }
            }
            // Return promise to get zoo distances for the species
            return get("http://localhost:3000/zoo_distances/"+postcode+"/"+Object.keys(zoosData).join());
        }).then(function(zooDistanceData) {
            // Add zoo distances to the list
            var distanceMap = {};
            for(var c = 0; c < zooDistanceData.length; c++) {
                domAddZooDistance(zooDistanceData[c]);
                distanceMap[zooDistanceData[c].metres] = zooDistanceData[c].zoo_id;
            }
            domReorderZoos(distanceMap);
        });
    });
</script>
</body>
</html>