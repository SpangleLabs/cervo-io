<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find zoo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>

Searching for:
<ul id="species_list"></ul>
Zoos:
<ul id="zoo_list"></ul>

<script>
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    function get(url) {
        // Return a new promise.
        return new Promise(function (resolve, reject) {
            // Do the usual XHR stuff
            var req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function () {
                // This is called even on 404 etc
                // so check the status
                if (req.status === 200) {
                    // Resolve the promise with the response text
                    resolve(JSON.parse(req.response));
                }
                else {
                    // Otherwise reject with the status text
                    // which will hopefully be a meaningful error
                    reject(Error(req.statusText));
                }
            };

            // Handle network errors
            req.onerror = function () {
                reject(Error("Network Error"));
            };

            // Make the request
            req.send();
        });
    }

    var speciesIdList = [];
    var zooIdList = [];

    function load_species_list() {
        var getType = getUrlParameter("type");
        if(getType === "species") {
            var speciesId = getUrlParameter("id");
            add_species_to_list(speciesId);
        } else {
            var categoryId = getUrlParameter("id");
            get_species_from_category(categoryId);
        }
    }

    function get_species_from_category(id) {
        console.log("get species");
        get("http://localhost:3000/categories/"+id).then(function(data) {
            for(var a = 0; a < data.length; a++) {
                var subcats = data[a].sub_categories;
                var species = data[a].species;
                for(var b = 0; b < species.length; b++) {
                    add_species_to_list(species[b].species_id);
                }
                for(var c = 0; c < subcats.length; c++) {
                    get_species_from_category(subcats[c].category_id);
                }
            }
        });
    }

    function add_species_to_list(species_id) {
        speciesIdList.push(species_id);
        get("http://localhost:3000/species/"+species_id).then(function(data) {
            $("#species_list").append("<li>"+data[0].common_name+"</li>");
            for(var a = 0; a < data[0].zoos.length; a++ ) {
                var zooData = data[0].zoos[a];
                if(zooIdList.indexOf(zooData.zoo_id) === -1) {
                    $("#zoo_list").append("<li id='zoo-"+zooData.zoo_id+"'>" + zooData.name + "</li>");
                    zooIdList.push(zooData.zoo_id);
                }
            }
        });
    }

    function promiseGetSpecies(speciesId) {
        //return a species promise which returns species data
        return get("http://localhost:3000/species/"+speciesId);
    }

    function promiseRawGetCategory(categoryId) {
        return get("http://localhost:3000/categories/"+categoryId);
    }

    function promiseGetCategory(categoryId) {
        //return a category promise which returns species promises
        console.log("Starting category "+categoryId);
        var categoryPromises = [];
        var speciesPromises = [];
        var result = promiseRawGetCategory(categoryId).then(function(data) {
            console.log(data);
            for (var a = 0; a < data.length; a++) {
                console.log(data[a]);
                var subcats = data[a].sub_categories;
                var species = data[a].species;
                for (var b = 0; b < species.length; b++) {
                    speciesPromises.push(promiseGetSpecies(species[b].species_id));
                }
                for (var c = 0; c < subcats.length; c++) {
                    categoryPromises.push(promiseGetCategory(subcats[c].category_id));
                }

                console.log("AAA");
            }
            return Promise.all(categoryPromises);
        }).then(function(specPromises) {
            console.log("BBB");
            console.log("DATA" + categoryId);
            //console.log(data);
            console.log(speciesPromises);
            console.log(specPromises);
            var specPromisesConcat = Array.prototype.concat.apply([],specPromises);
            console.log(specPromisesConcat);
            speciesPromises.concat(specPromisesConcat);
            console.log("CCC");
            return speciesPromises;
        });
        console.log("Result - "+categoryId);
        console.log(result);
        console.log("---");
        return result;
    }

    function get_zoo_distances() {
        var userPostcode = getUrlParameter("postcode");
        $.get("http://localhost:3000/zoo_distances/"+userPostcode+"/"+zooIdList.join(","), function(data) {
            for(var a = 0; a < zooIdList.length; a++) {
                $("li#zoo-"+zooIdList[a]).append(" Distance: "+data[a].metres);
            }
        });
    }

    $(document).ready(function() {
        promiseGetCategory(getUrlParameter("id")).then(function(data) {
            console.log("final");
            console.log(data);
            console.log("----");
        });
        //console.log(result);
        /*.then(function(data) {
            console.log("final");
            console.log(JSON.stringify(data));
        }).then(console.log);*/
        console.log("hey");
        //console.log(data);
        //load_species_list();
        // TODO: $.get returns promises, so make the above return a list of promises
        //get_zoo_distances();
    });
</script>
</body>
</html>