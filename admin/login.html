<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login to admin panel</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="../src/config.js"></script>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="./style.css" />
</head>
<body>
    <form id="login_form" method="post">
        <label>
            Username:
            <input type="text" name="username" id="form_username" />
        </label><br />
        <label>
            Password:
            <input type="password" name="password" id="form_password" />
        </label>
        <br />
        <input type="submit" value="Login" />
        <span id="failed-login">Failed to login</span>
    </form>
<script>

    function setAuthCookie(token) {
        let d = new Date();
        d.setTime(d.getTime() + (7 * 86400 * 1000)); //Expires in 7 days
        const expires = "expires="+d.toUTCString();
        document.cookie = "auth_token="+token+";"+expires+";path=/";
    }

    function getAuthCookie() {
        const authToken = document.cookie.replace(/(?:(?:^|.*;\s*)auth_token\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        return authToken;
    }

    function login() {
        const username = $("input#form_username").val();
        const password = $("input#form_password").val();
        // Post to API
        new Promise(function (resolve, reject) {
            // Do the usual XHR stuff
            let req = new XMLHttpRequest();
            req.open('POST', config["api_url"]+"sessions");
            req.setRequestHeader("Content-type", "application/json");
            req.onload = function () {
                // This is called even on 404 etc
                // so check the status
                if (req.status === 200) {
                    // Resolve the promise with the response text
                    resolve(JSON.parse(req.responseText));
                } else {
                    // Otherwise reject with the status text
                    // which will hopefully be a meaningful error
                    reject(Error(req.statusText));
                }
            };
            // Handle network errors
            req.onerror = function () {
                reject(Error("Network Error"));
            };
            // Make the request
            const passObj = {
                "username": username,
                "password": password
            };
            req.send(JSON.stringify(passObj));
        }).then(function(/*SessionObj*/resp) {
            // Get auth token
            const authToken = resp.auth_token;
            // Set token as cookie?
            setAuthCookie(authToken);
            // Redirect to index
            window.location.replace("index.html");
        }).catch(function(err) {
            console.log("Failed to login");
            $("#failed-login").show();
        });
        // Redirect to index?
        return false;
    }

    $("#login_form").submit(login);
</script>
</body>
</html>