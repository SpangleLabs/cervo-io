<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit species</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="../style.css" />
</head>
<body>
Animals list:
<a href="index.html">Back to admin index</a><br />
<ul id="animals"></ul>
</body>

<script>
    var category_level_cache = [];
    $.get("http://localhost:3000/category_levels/", function(data) {
        category_level_cache = data;
    });
    function get_category_levels() {
        return category_level_cache;
    }
    function get_category_level(id) {
        for ( var a = 0; a < category_level_cache.length; a++ ) {
            if(category_level_cache[a].category_level_id === id) {
                return category_level_cache[a];
            }
        }
    }

    function add_category(element, categoryData) {
        var categoryId = categoryData.category_id;
        var name = categoryData.name;
        var categoryLevelId = categoryData.category_level_id;
        var categoryLiId = "category-"+categoryId;
        var categoryLevelName = get_category_level(categoryLevelId).name;
        element.append("<li class='category closed' id='"+categoryLiId+"'>" +
            "<span onclick='load_category("+categoryId+")'>"+name+"</span> " +
            "<span class='category_level'>"+categoryLevelName+"</span>" +
            "</li>");
    }

    function add_species(element, speciesData) {
        //var speciesId = speciesData.species_id;
        var name = speciesData.common_name;
        var latinName = speciesData.latin_name;
        element.append("<li class='species'>"+name+" <span class='latin_name'>"+latinName+"</span></li>");
    }

    function add_new_species_form(element, parentCategoryId) {
        element.find("ul").append("<li class='species add'>" +
            "<span onclick='display_form("+parentCategoryId+")'>Add species </span>" +
            "<form class='add_species' onsubmit='send_add_species("+parentCategoryId+")'>" +
            "<input class='name' type='text' name='name'/>" +
            "<input class='latin_name' type='text' name='latin_name'>" +
            "<input type='submit' />" +
            "</form></li>");
    }

    function add_new_category_form(element, parentCategoryId) {
        var formString = "<li class='category add'>" +
            "<span onclick='display_form("+parentCategoryId+")'>Add category </span>" +
            "<form class='add_category' onsubmit='send_add_category("+parentCategoryId+")'>" +
            "<input class='name' type='text' name='name'/>" +
            "<select class='category_level_id' name='category_level_id'>";
        var catLevels = get_category_levels();
        for(var a = 0; a < catLevels.length; a++) {
            formString += "<option value='"+catLevels[a].category_level_id+"'>"+catLevels[a].name+"</option>";
        }
        formString += "</select>" +
            "<input type='submit'/>" +
            "</form></li>";
        element.find("ul").append(formString);
    }

    function display_form(id) {
        $("#category-"+id).find("form").show();
    }

    function send_add_species(categoryId) {
        var formElement = $("#category-"+categoryId).find("form.add_species");
        var inputName = formElement.find("input.name").val();
        var inputLatin = formElement.find("input.latin_name").val();
        var inputObj = {};
        inputObj.common_name = inputName;
        inputObj.latin_name = inputLatin;
        inputObj.category_id = categoryId;
        console.log(inputObj);
        $.post("http://localhost:3000/species/", inputObj);
        formElement[0].reset();
        return false;
    }

    function send_add_category(categoryId) {
        var formElement = $("#category-"+categoryId).find("form.add_category");
        var inputName = formElement.find("input.name").val();
        var inputlevelId = formElement.find("select").find(":selected").val();
        var inputObj = {};
        inputObj.name = inputName;
        inputObj.category_level_id = inputlevelId;
        inputObj.parent_category_id = categoryId;
        console.log(inputObj);
        $.post("http://localhost:3000/categories/", inputObj);
        formElement[0].reset();
        return false;
    }

    function load_category(id) {
        var categoryLiId = "category-"+id;
        $.get("http://localhost:3000/categories/"+id, function(/*CategoryObj*/data) {
            var listElement = $("#"+categoryLiId);
            listElement.addClass("open");
            listElement.removeClass("closed");
            if(!listElement.has("ul").length) {
                listElement.append("<ul></ul>");
                // Add subcategories and species
                $.each(data[0].sub_categories, function (index, itemData) {
                    add_category(listElement.find("ul"), itemData);
                });
                $.each(data[0].species, function (index, itemData) {
                    add_species(listElement.find("ul"), itemData);
                });
                // Adding forms
                if(data[0].category_level_id === 1) {
                    add_new_species_form(listElement, id);
                } else {
                    add_new_category_form(listElement, id);
                }
                // If category contains only 1 subcategory, open the subcategory.
                if(data[0].sub_categories.length === 1 && data[0].species.length === 0) {
                    load_category(data[0].sub_categories[0].category_id);
                }
            } else if(!listElement.find("ul").is(":visible")) {
                listElement.find("ul").first().show();
                listElement.addClass("open");
                listElement.removeClass("closed");
            } else {
                listElement.find("ul").first().hide();
                listElement.addClass("closed");
                listElement.removeClass("open");
            }
        })
    }

    $(document).ready(function() {
        $.get("http://localhost:3000/categories/", function(data) {
            $.each(data, function(index, itemData) {
                add_category($("#animals"), itemData);
            });
        });
    });
</script>
</html>