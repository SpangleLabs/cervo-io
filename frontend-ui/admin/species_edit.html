<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit species</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="./admin_config.js"></script>
    <link rel="stylesheet" href="../style.css" />
</head>
<body>
Animals list:
<a href="index.html">Back to admin index</a><br />
<ul id="animals" class="odd"></ul>
</body>

<script>
    var categoryLevelCache = [];
    $.get(config["api_url"]+"category_levels/", function(data) {
        categoryLevelCache = data;
    });
    function getCategoryLevels() {
        return categoryLevelCache;
    }
    function getCategoryLevel(id) {
        for ( var a = 0; a < categoryLevelCache.length; a++ ) {
            if(categoryLevelCache[a].category_level_id === id) {
                return categoryLevelCache[a];
            }
        }
    }

    function addCategory(element, categoryData) {
        var categoryId = categoryData.category_id;
        var name = categoryData.name;
        var categoryLevelId = categoryData.category_level_id;
        var categoryLiId = "category-"+categoryId;
        var categoryLevelName = getCategoryLevel(categoryLevelId).name;
        element.append("<li class='category closed' id='"+categoryLiId+"'>" +
            "<span onclick='loadCategory("+categoryId+")'>"+name+"</span> " +
            "<span class='category_level'>"+categoryLevelName+"</span>" +
            "</li>");
    }

    function addSpecies(element, speciesData) {
        //var speciesId = speciesData.species_id;
        var name = speciesData.common_name;
        var latinName = speciesData.latin_name;
        element.append("<li class='species'>"+name+" <span class='latin_name'>"+latinName+"</span></li>");
    }

    function addNewSpeciesForm(element, parentCategoryId) {
        element.find("ul").append("<li class='species add'>" +
            "<span onclick='displayForm("+parentCategoryId+")'>Add species </span>" +
            "<form class='addSpecies' onsubmit='sendAddSpecies("+parentCategoryId+")'>" +
            "<input class='name' type='text' name='name'/>" +
            "<input class='latin_name' type='text' name='latin_name'>" +
            "<input type='submit' />" +
            "</form></li>");
    }

    function addNewCategoryForm(element, parentCategoryId) {
        var formString = "<li class='category add'>" +
            "<span onclick='displayForm("+parentCategoryId+")'>Add category </span>" +
            "<form class='addCategory' onsubmit='sendAddCategory("+parentCategoryId+")'>" +
            "<input class='name' type='text' name='name'/>" +
            "<select class='category_level_id' name='category_level_id'>";
        var catLevels = getCategoryLevels();
        for(var a = 0; a < catLevels.length; a++) {
            formString += "<option value='"+catLevels[a].category_level_id+"'>"+catLevels[a].name+"</option>";
        }
        formString += "</select>" +
            "<input type='submit'/>" +
            "</form></li>";
        element.find("ul").append(formString);
    }

    function displayForm(id) {
        $("#category-"+id).find("form").show();
    }

    function sendAddSpecies(categoryId) {
        var formElement = $("#category-"+categoryId).find("form.addSpecies");
        var inputName = formElement.find("input.name").val();
        var inputLatin = formElement.find("input.latin_name").val();
        var inputObj = {};
        inputObj.common_name = inputName;
        inputObj.latin_name = inputLatin;
        inputObj.category_id = categoryId;
        console.log(inputObj);
        $.post(config["api_url"]+"species/", inputObj);
        formElement[0].reset();
        return false;
    }

    function sendAddCategory(categoryId) {
        var formElement = $("#category-"+categoryId).find("form.addCategory");
        var inputName = formElement.find("input.name").val();
        var inputlevelId = formElement.find("select").find(":selected").val();
        var inputObj = {};
        inputObj.name = inputName;
        inputObj.category_level_id = inputlevelId;
        inputObj.parent_category_id = categoryId;
        console.log(inputObj);
        $.post(config["api_url"]+"categories/", inputObj);
        formElement[0].reset();
        return false;
    }

    function loadCategory(id) {
        var categoryLiId = "category-"+id;
        $.get(config["api_url"]+"categories/"+id, function(/*CategoryObj*/data) {
            var listElement = $("#"+categoryLiId);
            var isOdd = listElement.parent("ul").hasClass("odd");
            listElement.addClass("open");
            listElement.removeClass("closed");
            if(!listElement.has("ul").length) {
                listElement.append("<ul class='"+(isOdd?"even":"odd")+"'></ul>");
                // Add subcategories and species
                $.each(data[0].sub_categories, function (index, itemData) {
                    addCategory(listElement.find("ul"), itemData);
                });
                $.each(data[0].species, function (index, itemData) {
                    addSpecies(listElement.find("ul"), itemData);
                });
                // Adding forms
                if(data[0].category_level_id === 1) {
                    addNewSpeciesForm(listElement, id);
                } else {
                    addNewCategoryForm(listElement, id);
                }
                // If category contains only 1 subcategory, open the subcategory.
                if(data[0].sub_categories.length === 1 && data[0].species.length === 0) {
                    loadCategory(data[0].sub_categories[0].category_id);
                }
            } else if(!listElement.find("ul").is(":visible")) {
                listElement.find("ul").first().show();
                listElement.addClass("open");
                listElement.removeClass("closed");
            } else {
                listElement.find("ul").first().hide();
                listElement.addClass("closed");
                listElement.removeClass("open");
            }
        })
    }

    $(document).ready(function() {
        $.get(config["api_url"]+"categories/", function(data) {
            $.each(data, function(index, itemData) {
                addCategory($("#animals"), itemData);
            });
        });
    });
</script>
</html>